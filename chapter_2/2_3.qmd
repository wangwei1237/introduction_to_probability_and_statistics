## 对数据集进行汇总 {#sec-2_3}
如今的实验涉及到的数据规模通常比较大。例如，为了了解某些行为习惯对健康的影响，1951 年，医学统计学家 R. Doll 和 A. B. Hill 向英国的所有医生发起了一项调查问卷，并且回收到了大约 40,000 份问卷。问卷的问题涉及年龄、饮食习惯和吸烟习惯。随后，Doll 和 Hill 对问卷回复者进行了为期 10 年的跟踪调查，并对其中的死亡人员的死因进行了监测。为了感知如此大量的数据，需要选择适当的方法对数据进行总结。在本节中，我们将介绍一些汇总数据的统计量，其中统计量是一个数值，数据集决定了其统计量的具体数值。

::: {.callout-note title="The British Doctors’ Study (1951–2001)"}
1951 年，R. Doll 和 A. B. Hill 向英国的 6 万名医生发出调查问卷，并跟踪他们的吸烟情况和健康情况。根据跟踪情况，Doll 和 Hill 提交了两份报告（统称为英国医生研究）：1954 年提交的 [The Mortality of Doctors in Relation to Their Smoking Habits](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2085438/) 和 1956 年提交的 [Lung Cancer and Other Causes of Death in Relation to Smoking](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2035864/)。报告中公布了吸烟与疾病发病率的确凿科学证据，报告一经发布就震惊了世界，就连 Doll 本人也吓得戒掉了自己的重度烟瘾。

针对英国医生的跟踪调查一直持续到 2001 年，当时参与问卷的大多数参与者已经故去，并且还在世的最年轻的参与者也已经七十多岁了。在近 50 年的研究中，研究人员公布了多项报告，这些报告强化了公众对吸烟会导致呼吸道疾病和心血管疾病的认知。

关于这项研究的内容可以参阅：[The British Doctors’ Study (1951–2001)](https://embryo.asu.edu/pages/british-doctors-study-1951-2001)。
:::


### 样本均值，样本中位数和样本众数 {#sec-2_3_1}
在这一节中，我们将介绍一些用于描述数据集中心（*center*）的统计量。首先，假设我们有一个由 $n$ 个数据构成的数据集：$x_1，x_2，...，x_n$ 。这 $n$ 个数的算术平均数（*arithmetic average*）就是样本均值（*sample mean*）。

::: {#def-sample_mean}
**样本均值**（*sample mean*） $\overline{x}$ 的定义如下：

$$
\overline{x} = \frac{\sum_{i=1}^{n}{x_i}}{n}
$$ {#eq-2_3_1_001}
:::

如果 $a$，$b$ 为常数，并且

$y_i = ax_i+b, i\in[1,n]$

那么，数据集 $y_1,...,y_n$ 的样本均值为：

$$
\begin{align}
\overline{y}&=\frac{\sum_{i=1}^{n}{ax_i+b}}{n} \\
&= \frac{\sum_{i=1}^{n}{ax_i}}{n} + \frac{\sum_{i=1}^{n}{b}}{n} \\
&= a\overline{x}+b
\end{align}
$$ {#eq-2_3_1_002}

::: {#exr-2_3_a}
2004 年至 2013 年，美国高尔夫球大师赛的获胜分数如下：

$280, 278, 272, 276, 281, 279, 276, 281, 289, 280$

请计算如上分数的 **样本均值**。
:::

::: {#sol-2_3_a}
比起直接将这些分数相加，对于每个分数而言，先减去 280 以获得新值 $y_i = x_i - 280$ 会更容易计算其样本均值：

$0, −2, −8, −4, 1, −1, −4, 1, 9, 0$
:::

$y_i$ 的算术平均数为 $-\frac{8}{10}$，因此 $\overline{y}=-\frac{8}{10}$，所以 $\overline{x}=\overline{y}+280=279.2$。

有时，我们想要确定一个用频率表来描述的数据集的样本均值，在频率表中存在 $k$ 个不同的值 $v_1,...,v_k$，以及它们对应的频率 $f_1,...,f_k$。该数据集由 $n=\sum_{i=1}^{k}{f_i}$ 个值组成，其中值 $v_i$ 出现 $f_i$ 次，因此这 $n$ 个数据的样本均值为：

$$
\overline{x}=\sum_{i=1}^{k}{\frac{v_if_i}{n}}
$$ {#eq-2_3-1_003}

对上述计算进行展开，得到：

$\overline{x}=\frac{f_1}{n}{v_1} + \frac{f_2}{n}{v_2} + ... + \frac{f_k}{n}{v_k}$

因此，样本均值是数据集中不同值的加权平均数，其中 $v_i$ 的权重等于 $n$ 个数据中值等于 $v_i$ 的数据的占比。

::: {#exr-2_3_b}
如下的频率表给出了青少年交响乐团的成员年龄分布。

```{r}
library(knitr)

df <-data.frame(
  Age = c(15, 16, 17, 18, 19, 20),
  Frequency = c(2, 5, 11, 9, 14, 13)
)

kable(df, align = "l")
```

计算该交响乐团中 54 位成员的年龄的样本均值。
:::

::: {#sol-2_3_b}

$\overline{x} = (15·2 + 16·5 + 17·11 + 18·9 + 19·14 + 20·13) / 54 ≈ 18.24$

:::

另一个用于表示数据集中心的统计量是样本中位数（*sample median*），简单来说，中位数就是当数据集中的数据按递增顺序排列后，位于数据集中间的数。

::: {#def-sample_median}
把大小为 $n$ 的数据集中的数据从小到大排序。如果 $n$ 是奇数，则 **样本中位数** 就是第 $\frac{(n + 1)}{2}$ 个数；如果 $n$ 是偶数，则 **样本中位数** 就是第 $\frac{n}{2}$ 个数和第 $\frac{n}{2} + 1$ 个数的平均值。
:::

因此，3 个数的样本中位数是其第 2 小的数；4 个数的样本中位数是第 2 小和第 3 小的数的平均值。

::: {#exr-2_3_c}
找出 @exr-2_3_b 中的样本中位数。
:::

::: {#sol-2_3_c}
由于有 54 个数，因此当数据按递增顺序排列后，样本中位数是第 27 个数和第 28 个数的平均值。因此，样本中位数是 18.5。
:::

样本均值和样本中位数都是描述数据集中心趋势的、非常有用的统计量。样本均值的计算会用到数据集中的所有数据，并且容易受到数据集中极端值（远远大于或小于数据集中大多数数据的数据）的影响。样本中位数的计算只会到数据集中的一个或两个数据，因此样本中位数不受数据集中的极端值的影响。样本均值更好还是样本中位数更好，取决于我们试图从数据中学习什么。

* 如果政府有统一的个人所得税税率，并试图估计税收总额，那么可以使用居民收入的样本均值作为统计量指标。
* 如果政府正在考虑建造保障房，并希望确定能够负担得起这种住房的居民人口比例，那么更好的方式则是使用样本中位数。

::: {#exr-2_3_d}
1972 年，Hoel, D. G.  发表了一篇论文 [A representation of mor- tality data by competing risks](https://pubmed.ncbi.nlm.nih.gov/4556703/)。在这篇论文中，Hoel 首先让一组 5 周大的小白鼠接受 300rad 的辐射剂量，然后把这些小白鼠分成两组：第一组置于无菌环境中，第二组则置于常规的实验室环境。随后，Hoel 观察并记录这些小白鼠的生存天数。以下的茎叶图（茎以百天为单位）记录了因胸腺淋巴瘤死亡的小白鼠的数据：第一张图是生活在无菌条件下的小白鼠，第二张图是生活在普通实验室条件下的小白鼠。

::: {#tbl-mice layout-ncol=2}

|Stem |Leaf                                   |
|:----|:--------------------------------------|
|1    |58, 92, 93, 94, 95                     |
|2    |02, 12, 15, 29, 30, 37, 40, 44, 47, 59 |
|3    |01, 01, 21, 37                         |
|4    |15, 34, 44, 85, 96                     |
|5    |29,37                                  |
|6    |24                                     |
|7    |07                                     |
|8    |00                                     |

: 无菌环境下的小白鼠

|Stem |Leaf                           |
|:----|:------------------------------|
|1    |59, 89, 91, 98                 |
|2    |35, 45, 50, 56, 61, 65, 66, 80 |
|3    |43, 56, 83                     |
|4    |03, 14, 28, 32                 |

: 正常实验室环境下的小白鼠

不同环境下的小白鼠实验
:::

计算两组小白鼠的生存时间的样本均值和样本中位数。
:::

::: {#sol-2_3_d}
从茎叶图中可以清晰地看出，无菌环境下小白鼠的样本均值（344.07）大于常规实验室环境下小白鼠的样本均值（292.32）。另一方面，由于无菌环境下的小白鼠有 29 个数据值，所以其样本中位数是第 15-最大 的数据值，即 259。另一组小白鼠的样本中位数是第 10-最大 的数据值，即 265。因此，尽管第一组数据的样本均值大于第二组，但这两组数据的样本中位数却大致基本一致。其中的原因在于，第一组数据中大于 500 的 5 个数据对其样本均值的影响较大，但对其样本中位数的影响要小得多。事实上，如果把大于 500 的 5 个数据替换为任何其他五个大于或等于 259 的数据，其样本中位数将保持不变。从茎叶图来看，无菌环境可能延长了五只寿命最长的小白鼠的寿命，但无法确定无菌环境是否对其他小白鼠的寿命产生了什么别的影响。
:::

另一个用于表示数据集中心趋势的统计量是 **样本众数**（*sample mode*）。在数据集中，出现频率最高的值为 **样本众数**。如果出现频率最高的值有多个，那么所有出现频率最高的这些数值都是 **样本众数**。

::: {#exr-2_3_e}
以下的频率表为抛 40 次骰子获得的结果。

```{r}
library(knitr)

df <- data.frame(
    Value = c(1, 2, 3, 4, 5, 6),
    Frequency = c(9, 8, 5, 5, 6, 7)
)
kable(df, align = "l")
```

* 计算其样本均值
* 计算其样本中位数
* 计算器样本众数
:::

::: {#sol-2_3_e}
* 样本均值为 $\overline{x}=(9 + 16 + 15 + 20 + 30 + 42) / 40 = 3.05$
* 样本中位数为 第 20-最小 和 第 21-最小 的平均数 3
* 样本众数为 1
:::

### 样本方差和样本标准差 {#sec-2_3_2}
虽然我们已经介绍了用于描述数据集中心趋势的统计量，但我们也对描述数据波动的统计量感兴趣。可以通过计算数据值与样本均值之间距离的平方的平均值来描述数据集中数据的波动，这就是样本方差（*sample variance*）。出于技术原因，在计算样本方差时，需要除以 $n-1$ 而不是 $n$（$n$ 是数据集的大小）。

::: {#def-variance}
对于数据集 ${x_1,...,x_n}$，其 **样本方差** $s^2$ 的定义如下：

$$
s^2 = \frac{\sum_{i=1}^{n}{(x_i-\overline{x})^2}}{n - 1}
$$ {#eq-2_3_2-001}
:::

::: {#exr-2_3_f}
计算如下两个数据集的样本方差：

* A: 3, 4, 6, 7, 10
* B: -20, 5, 15, 24
:::

::: {#sol-2_3_f}
对于 A 而言，其样本均值 $\overline{x} = (3 + 4 + 6 + 7 + 10) / 5 = 6$，因此，其样本方差为：
$s^2 = [(−3)^2 + (−2)^2 + 0^2 + 1^2 + 4^2] / 4 = 7.5$

对于 B 而言，其样本均值也是 6，因此，其样本方差为：
$s^2 = [(−26)^2 + (−1)^2 + 9^2 + (18)^2] / 3 ≈ 360.67$
:::

通过 @sol-2_3_f 可发现，虽然 A 和 B 的样本均值是一样的，但是 B 的样本方差远大于 A。

在计算样本方差时，会经常用到如下的数学等式：

$$
\sum_{i=1}^{n}{(x_i-\overline{x})^2} = \sum_{i=1}^{n}{x_i^2} - n\overline{x}^2
$$ {#eq-2_3_2_002}

@eq-2_3_2_002 的证明过程如下：

$$
\begin{align}  
\sum_{i=1}^{n}{(x_i-\overline{x})^2} &= \sum_{i=1}^{n}{(x_i^2 - 2x_i\overline{x} + \overline{x}^2)} \\
&=\sum_{i=1}^{n}{x_i^2} - 2\overline{x}\sum_{i=1}^{n}{x_i} + \sum_{i=1}^{n}{\overline{x}^2} \\
&=\sum_{i=1}^{n}{x_i^2} - 2n\overline{x}^2 + n\overline{x}^2 \\
&=\sum_{i=1}^{n}{x_i^2} - n\overline{x}^2
\end{align} 
$$

如果 $y_i = ax_i + b$，$i = 1,...,n$，则 $\overline{y} = a\overline{x} + b$，因此：

$\sum_{i=1}^{n}{(y_i - \overline{y})^2} = a^2\sum_{i=1}^{n}{(x_i-\overline{x})^2}$

所以：

$$
s_y^2 = a^2s_x^2
$$ {#eq-2_3_2_003}

换句话说，为数据集中的每个数据增加一个常数不会改变其样本方差；而让数据集中的每个数据乘以一个常数则会得到一个新的样本方差，新的样本方差等于原来的样本方差乘以该常数的平方。

::: {#exr-2_3_g}
下表给出了 1997 年至 2005 年间全球商业航空运输中导致人员死亡的事故数量。

```{r}
library(knitr)

df <- data.frame(
    Year=seq(1997, 2005, by=1),
    Accidents = c(25, 20, 21, 18, 13, 13, 7, 9, 18))

kable(df, align="l")
```

根据如上的数据，计算航工事故的样本方差。
:::

::: {#sol-2_3_g}
将数据集中的数据都减去 18，我们得到一个新的数据集：

$y = \{7,2,3,0,−5,−5,−11,−9,0\}$

$\overline{y} = \sum_{i=1}^{9}{y_i} / 9 = -2$

$\sum_{i=1}^{9}{y_i^2} = 49 + 4 + 9 + 25 + 25 + 121 + 81 = 314$

因为新的数据集的方差和原数据集是一样的，因此根据 @eq-2_3_2_002：

$s^2 = \frac{\sum_{i=1}^{9}{y_i^2} - n\overline{x}^2}{n - 1} = \frac{314 - 9·4}{8} = 34.75$
:::

::: {.callout-note}
因为 $y_i = x_i - 20$，因此，根据 @eq-2_3_2_003， $y$ 和 $x$ 的方差是一样的。 
:::

样本方差的平方根称之为 **样本标准差**（*sample standard deviation*）。

::: {#def-ssd}
样本标准差 $s$的定义如下所示：

$$
s = \sqrt{\frac{\sum_{i=1}^{n}{(x_i-\overline{x})^2}}{n - 1}}
$$ {#eq-2_3_2_004}
:::

### 样本百分位数和箱线图 {#sec-2_3_3}
简单来说，数据集的 **样本$100p$-百分位数** 是指小于或等于数据集中 $100p\%$ 的数据所对应的数据值，其中 $0 \le p \le 1$。

::: {#def-2_3_3_pp}
**样本$100p$-百分位数** 是数据集中的一个数据值，这个值满足至少 $100p\%$ 的数据小于或等于它，并且至少 $100(1-p)\%$ 的数据大于或等于它。如果存在两个数据值满足这个条件，那么该数据集的 **样本$100p$-百分位数** 是这两个值的算术平均数。
:::

为了确定大小为 $n$ 的数据集的样本$100p$-百分位数，我们需要确定这样的数据值，以使得该值满足如下的条件：

1. 至少有 $np$ 个数据小于或等于该值
2. 至少有 $n(1-p)$ 个数据大于或等于该值

为了计算样本$100p$-百分位数，首先要对数据集进行升序排列。

* 如果 $np$ 不是整数，那么唯一满足前述条件的数据值是数据从小到大排序后，位置大于 $np$ 的最小整数所对应的值。例如，如果 $n=22$，$p=0.8$，那么我们需要一个数据值，使得至少有 17.6 个数据小于或等于它，并且至少有 4.4 个数据大于或等于它。显然，只有第 18 小的值同时满足这两个条件，这就是 样本80-百分位数。
* 如果 $np$ 是整数，那么很容易发现 $np$ 和 $np+1$ 这两个位置的数据都满足前述条件，因此样本 $100p$-百分位数就是这两个数据值的算术平均数。例如，如果我们想计算大小为 20 的数据集的 90-百分位数，那么第 18-小 和第 19-小 的值都会使得至少有 90% 的数据小于或等于它们，并且至少有 10% 的数据大于或等于它们。因此，90-百分位数是这两个值的平均数。

::: {#exr-2_3_h}
@tbl-us_pupulation 列出了 2006 年美国人口最多的 25 个城市的人口数。对于这组数据，找出：

* 样本10-百分位数
* 样本80-百分位数。

:::

```{r}
#| label: tbl-us_pupulation
#| tbl-cap: "2006 年 7 月，美国 25 个最大城市的人口数据"
#| warning: false
library(knitr)
df <- read.table("../misc/US_population.csv", header=TRUE, sep=",")
kable(df, align="l")
```

::: {#sol-2_3_h}
* 因为样本的大小是 25，25·0.1 = 2.5，因此，样本10-百分位数就是样本第 3-小的数据，也就是 590763。
* 因为 25·0.8 = 20，因此，样本80-百分位数是第 20-小和第 21-小的算术平均数，$\frac{1512986 + 1448394}{2}$，也就是 1480690。
:::

样本50-百分位数，就是样本中位数。样本25-百分位数、样本50-百分位数、样本75-百分位数一起构成了样本四分位数（*sample quartiles*）。

::: {#def-2_3_quartiles}
样本25-百分位数称之为 **第一四分位数**（*the first quartile*），样本50-百分位数称之为 **样本中位数** 或 **第二四分位数**（*the second quartile*），样本75-百分位数称之为 **第三四分位数**（*the third quartile*）
:::

::: {.callout-note}
有时，也会把样本四分位数称为下四分位数和上四分位数：下四分位数（25-百分位数），中位数（50-百分位数），上四分位数（75-百分位数）。
:::

四分位数把数据集分为四个部分，大约 25% 的数据小于第一四分位数，25% 的数据位于第一四分位数和第二四分位数之间，25% 的数据位于第二四分位数和第三四分位数之间，剩余的 25% 的数据大于第三四分位数。

::: {#exr-2_3_i}
我们使用分贝（*dB*）来测量噪音。听力正常的人在安静环境下能听到的最弱的声音大约是 1dB，窃窃私语时的声音大约是 30dB，人们正常交谈时的声音大约是 70dB，收音机的音量大约是 100dB。当声音超过 120 dB 时，耳朵就开始感知到不适了。

曼哈顿中央车站外测量到的 36 个不同时间点的噪音水平如下所示：

```{.bash filename="曼哈顿中央车站噪音水平"}
82, 89, 94, 110, 74, 122, 112, 95, 100, 78, 65, 60, 90, 83, 87, 75, 114, 85 69, 94, 124, 115, 107, 88, 97, 74, 72, 68, 83, 91, 90, 102, 77, 125, 108, 65
```

计算如上数据的四分位数。
:::

::: {#sol-2_3_i}
因为 $n = 36$，所以四分位数对应的 $np$ 均为整数，因此其对应的四分位数值为第 $np$-小和第 $(np+1)$-小的平均数。

* 第一四分位数（$p=0.25$）：第 9-小和第 10-小的平均值，也就是 74.5。
* 第二四分位数（$p=0.5$）：第 18-小和第 19-小的平均值，也就是 89.5。
* 第三四分位数（$p=0.75$）：第 27-小和第 28-小的平均值，也就是 104.5。
:::

我们经常用箱线图（*box plot*）绘制数据集的汇总统计量。

1. 在横坐标轴上绘制一条从最小值到最大值的直线段。
2. 在这条直线上叠加一个 “箱子”，该箱子从第一四分位数开始一直延伸到第三四分位数，并用垂直线表示第二四分位数。

例如，@tbl-StartingYearlySalaries 中给出的 42 个起薪数据覆盖了从最低值 57000$ 到最高值 70000$ 之间的数。第一四分位数（第 11-小的值）是 60000$，第二四分位数（第 21-小和第 22-小的平均值）是 61500$，第三四分位数（第 32-小的值）是 64000$。该数据集的箱线图如 @fig-StartingYearlySalaries_box 所示。

```{r}
#| label: fig-StartingYearlySalaries_box
#| fig-cap: "起薪线图"
#| warning: false

library(ggplot2)
ss <- c(57, 58, 59, 60, 61, 62, 63, 64, 66, 67, 70)
f <- c(4, 1, 3, 5, 8, 10, 0, 5, 2, 3, 1)
df <- data.frame(value=rep(ss, f))
ggplot(df, aes(x=value, y="")) +
  geom_boxplot() + 
  labs(x="Starting Salary", y="")
```

::: {.callout-note}
@fig-StartingYearlySalaries_box 中的箱线图和文中对各四分位数的计算并不一致，这主要是因为该图使用 R 的 `ggplot2` 包绘制，对于该包而言，在绘制箱线图时，会剔除数据中可能的离群点（$\pm 1.5IQR$），离群点在图中显示为一个点。
:::

箱线图上直线的长度等于数据集中的最大值减去数据集中的最小值，称为数据范围。箱线图中箱子的长度等于第三四分位数减去第一四分位数，称为四分位距（*IQR: inter quaritle range*）。