## 概率模型的所有参数都指定时的拟合优度检验 {#sec-11_2}
假设有 $n$ 个独立的随机变量 $Y_1, Y_2, \dots, Y_n$，其中每个变量的取值为 $1, 2, \dots, k$，我们希望检验如下的零假设：$Y_j$ 的概率质量函数为 $\{ p_i, i = 1, \dots, k \}$。也就是说，如果用 $Y$ 表示任意一个 $Y_j$，那么零假设为：

$H_0: P\{Y = i\} = p_i, \quad i = 1, \dots, k$

备择假设为：

$H_1: P\{Y = i\} \neq p_i, \quad \text{对于某些} i = 1, \dots, k$

为了检验上述假设，令 $X_i$（$i = 1, \dots, k$）表示 $Y_j$ 等于 $i$ 的数量。由于每个 $Y_j$ 都独立地以概率 $P\{Y = i\}$ 等于 $i$，那么原假设 $H_0$ 为真时，$X_i$ 服从参数为 $n$ 和 $p_i$ 的二项分布。因此，当原假设 $H_0$ 为真时，

$E[X_i] = np_i$

因此，可以用 $(X_i - np_i)^2$ 来判断 $p_i$ 是否确实等于 $P\{Y = i\}$。当 $(X_i - np_i)^2$ 比较大时，则表明 $H_0$ 可能不成立。实际上，这种推理让我们考虑以下检验统计量：

$$
T = \sum_{i=1}^k \frac{(X_i - np_i)^2}{np_i}
$$ {#eq-11_2_1}

并且，当 $T$ 较大时，我们将拒绝零假设。

为了确定临界区，首先需要指定显著性水平 $\alpha$，然后确定满足下式的临界值 $c$：

$P_{H_0}\{T \geq c\} = \alpha$

也就是说，我们需要确定 $c$，使得当 $H_0$ 为真时，统计量 $T$ 大于等于 $c$ 的概率为 $\alpha$。在显著性水平 $\alpha$ 下，当 $T \geq c$ 时，则需要拒绝原假设 $H_0$，否则就接受原假设。

接下来我们需要确定 $c$ 的值。确定 $c$ 的经典的方法是使用如下的结论：当 $n$ 较大时，在 $H_0$ 为真时，$T$ 近似服从自由度为 $k - 1$ 的卡方分布（当 $n \rightarrow \infty$ 时，$T$ 服从自由度为 $k-1$ 的卡方分布）。因此，当 $n$ 较大时，$c$ 的取值可以是 $\chi^2_{\alpha, k-1}$，因此在显著性水平为 $\alpha$ 时的近似检验为：

$\begin{align} \text{拒绝} \quad &H_0 \quad \text{如果} T \geq \chi^2_{\alpha, k-1} \\ \text{接受} \quad &H_0 \quad \text{否则} \end{align}$

如果观察到的统计量 $T$ 的值为 $t$，那么上述检验等价于在 $\alpha$ 值大于或等于如下的 $p-\text{value}$ 时拒绝 $H_0$：

$p-\text{value} = P_{H_0}\{T \geq t\} \approx P\{\chi^2_{k-1} \geq t\}$

其中 $\chi^2_{k-1}$ 是自由度为 $k - 1$ 的卡方分布随机变量。

经验规则指出，对于 $n$ 来说，$n$ 需要足够大才能使得如上的检验是一个比较好的近似检验，一般而言，对于每个 $i, i = 1,..., k$，需要满足 $np_i \geq 1$，并且至少 80% 的 $np_i$ 值应大于 5。

::: {.callout-tip title="备注"}
* (a) 可以展开 @eq-11_2_1 中的平方项并根据 $\sum p_i = 1$ 和 $\sum X_i = n$ 来更简单的计算 $T$（为什么可以这样计算？）：

$$
\begin{align}
T &= \sum_{i=1}^k \frac{X_i^2 - 2np_i X_i + n^2 p_i^2}{np_i} \\
&= \sum_i \frac{X_i^2}{np_i} - 2 \sum_i X_i + n \sum_i p_i \\
&= \sum_i \frac{X_i^2}{np_i} - n
\end{align}
$$ {#eq-11_2_2}

* (b) 直观上而言，依赖于 $X_1, \dots, X_k$ 值的检验统计量 $T$ 只有 $k - 1$ 个自由度的原因是：有一个自由度因为线性关系 $\sum_i X_i = n$ 而丢失了。

* (c) 虽然证明 $T$ 渐近地服从卡方分布非常复杂，但当 $k = 2$ 时，可以很轻松的证明 $T$ 服从卡方分布。当 $k = 2$ 时，由于 $X_1 + X_2 = n$，且 $p_1 + p_2 = 1$，有：

$$
\begin{align}
T &= \frac{(X_1 - np_1)^2}{np_1} + \frac{(X_2 - np_2)^2}{np_2} \\
&= \frac{(X_1 - np_1)^2}{np_1} + \frac{(n - X_1 - n[1 - p_1])^2}{n(1 - p_1)} \\
&= \frac{(X_1 - np_1)^2}{np_1} + \frac{(X_1 - np_1)^2}{n(1 - p_1)} \\
&= \frac{(X_1 - np_1)^2}{np_1(1 - p_1)} \quad \because \frac{1}{p} + \frac{1}{1 - p} = \frac{1}{p(1 - p)}
\end{align}
$$

因为 $X_1$ 是一个二项分布随机变量，其均值为 $np_1$，方差为 $np_1(1 - p_1)$，因此，根据二项分布的正态近似性，可以得出：当 $n$ 比较大时，$\frac{(X_1 - np_1)}{\sqrt{np_1(1 - p_1)}}$ 近似服从标准正态分布，因此 $\frac{(X_1 - np_1)^2}{np_1(1 - p_1)}$ 近似服从自由度为 1 的卡方分布。
:::

::: {#exr-11_2_a}
近年来，心理健康与身体健康之间的相关性逐渐得到人们的认可。可以使用名人的生日和去世日期之间的数据分析来进一步的研究这种相关性。为了使用这些数据，我们假设：人们对某件事情的盼望能够改善一个人的心理状态。因为生日会带来更多的关注、关爱，因此一位名人可能会对他/她的生日充满期待。如果这位名人身体不好并且濒临死亡，那么对生日的期待可能会“令他振奋，从而改善他的健康状态，并降低他在生日之前去世的概率。” 数据可能显示：名人在他/她的生日前几个月去世的可能性较小，而在生日之后的几个月去世的可能性较大。
:::

::: {#sol-11_2_a}
为了验证如上的假设，从《Who Was Who in America》一书中随机选取了 1251 名已故美国名人，书中记录了这些名人的出生日期和去世日期。样本数据取自 D. Phillips 的 *Death Day and Birthday: An Unexpected Connection*，具体的数据如 @tbl-11_1 所示[^1]。

| 生日前后的月数 | 死亡数 |
|-------------------------- |------------------|
| 6 Months Before           | 90               |
| 5 Months Before           | 100              |
| 4 Months Before           | 87               |
| 3 Months Before           | 96               |
| 2 Months Before           | 101              |
| 1 Month Before            | 86               |
| The Month                 | 119              |
| 1 Month After             | 118              |
| 2 Months After            | 121              |
| 3 Months After            | 114              |
| 4 Months After            | 113              |
| 5 Months After            | 106              |

: 在生日的前后几个月中死亡数量的分布图，$n=1251$，$n / 12 = 104.25$ {#tbl-11_1}

如果去世日期与生日无关，那么这 1251 个人的去世日期在 12 个类别（*categories*）中的每个类别的可能性都是相同的。因此，我们可以检验以下的零假设：

$H_0: p_i = \frac{1}{12}, \quad i = 1, \dots, 12$

由于 $np_i = 1251/12 = 104.25$，该假设的卡方检验统计量为：

$T = \frac{(90)^2 + (100)^2 + (87)^2 + \dots + (106)^2}{104.25} - 1251 = 17.192$

$p-\text{value}$ 为：

$p-\text{value} \approx P(\chi_{11}^2 \geq 17.192) = 1 - \text{pchisq}(17.192, 11) = 0.1023232$

检验的结果让我们对即将到来的生日是否对人的余生有影响的假设存在一些质疑。尽管这些数据不足以在 10% 的显著性水平下拒绝该假设，但它们确实表明了原假设可能是错误的。于是我们有了一个新的问题：在分析中，我们是否应该有多达 12 个数据类别，是否允许通过更少的可能类别来获得更强的检验？例如，假设我们将数据分为 4 个可能的类别：

- **类别 1**: $-6, -5, -4$
- **类别 2**: $-3, -2, -1$
- **类别 3**: $0, 1, 2$
- **类别 4**: $3, 4, 5$

也就是说，如果某人的去世日期发生在其生日前三个月内，则将其归为 **类别 2**。根据这种分类，我们得到如下的数据：

|  | 死亡人数 |
|---------|---------------------------|
| 1       | 277                       |
| 2       | 283                       |
| 3       | 358                       |
| 4       | 333                       |

于是：$n = 1251$，$\quad n/4 = 312.75$。

$H_0: p_i = \frac{1}{4}, \quad i = 1, 2, 3, 4$ 的检验统计量为：

$T = \frac{(277)^2 + (283)^2 + (358)^2 + (333)^2}{312.75} - 1251 = 14.775$

因此，由于 $\chi_{01,3}^2 = 11.345$，所以即使在 1% 的显著性水平下，我们也会拒绝原假设。使用 R 计算得到的 $p-\text{value}$ 为：

$p-\text{value} = P\{\chi_3^2 \geq 14.775\} = 1 - \text{pchisq}(14.775, 3) = 0.00201938$

然而，如上的原假设是在观察到数据后提出的，因此上述分析可能会受到批评。确实，虽然使用一组数据来确定原假设的“正确表达方式”没有错，但再次利用这些相同的数据来检验该假设的做法是值得怀疑的。因此，要确保得出可靠的结论，按照上述的数据处理方式选择第二个随机样本似乎是必须的，并且需要在新的样本上再次检验 $H_0: p_i = \frac{1}{4}, \quad i = 1, 2, 3, 4$（参见 **习题 3**）。$\blacksquare$
:::

可以使用 R 计算检验统计量和 $p-\text{value}$。假设 $x = c(x_1,...,x_k)$ 是 $k$ 个不同的类别上的对应样本数量，并且我们希望检验原假设 $H_0: P\{i = k\} = p_i$。可以使用如下的 R 代码：

```{.r}
x <- c(x1,...xk)
chisq.test(x, p=c(p1,...pk))
```

例如，对于 @exr-11_2_a 而言，

```{r}
#| code-fold: false
#| warning: false

x <- c(277, 283, 358, 333)
p <- c(1/4, 1/4, 1/4, 1/4)
chisq.test(x, p=p)
```

::: {#exr-11_2_b}
某荧光灯制造商对一位购货量非常大的顾客说：他们生产的这些灯泡的质量并不统一，而是按照某种方式生产的。具体而言，他们生产的每个灯泡的质量划分为 A、B、C、D、E 这 5 个等级，并且不同质量等级的灯泡的生产是独立的，同时不同等级对应的概率分别为 0.15、0.25、0.35、0.20 和 0.05。然而，该顾客认为他收到的 E 型（最低质量）灯泡太多，因此他决定花费时间和成本来确定 30 个灯泡的质量，以此来检验制造商的说法。假设他发现这 30 个灯泡中，3 个是 A 等级，6 个是 B 等级，9 个是 C 等级，7 个是 D 等级，5 个是 E 等级。那么，根据这些数据，在 5% 的显著性水平下，该顾客是否能拒绝制造商的说法？
:::

::: {#sol-11_2_b}
```{r}
#| code-fold: false
#| warning: true

x <- c(3, 6, 9, 7, 5)
p <- c(0.15, 0.25, 0.35, 0.20, 0.05)
chisq.test(x, p=p)
```

注意，由于每个类别中的样本量相对较小，所以 R 给出了如下警告：卡方分布对检验统计量分布的近似可能不完全准确。假设结果的准确性没有问题，则在 5% 的显著性水平下，我们不会拒绝原假设。但由于在所有高于 0.053 的显著性水平下，我们都将拒绝原假设，因此该顾客应对制造商的说法保持怀疑态度。$\blacksquare$
:::

### 通过模拟确定临界区域 $^*$ {#sec-11_2_1}

[^1]: D. Phillips, “Death Day and Birthday: An Unexpected Connection,” in Statistics: A Guide to the Unknown, Holden-Day, 1972.