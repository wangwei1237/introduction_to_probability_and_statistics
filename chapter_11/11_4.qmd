## 列联表的独立性检验 {#sec-11_4}
在本节中，我们将考虑这样的问题：总体中的每个成员都可以根据两个不同的特征（*characteristics*）进行分类——我们将这些特征分别记作 $X-\text{特征}$ 和 $Y-\text{特征}$。假设 $X-\text{特征}$ 有 $r$ 个可能的取值，$Y-\text{特征}$ 有 $s$ 个可能的取值。对于 $i = 1, \dots, r$，$j = 1, \dots, s$，定义

$P_{ij} = P\{X = i, Y = j\}$

也就是说，$P_{ij}$ 表示随机选择的一个总体成员具有 $X-\text{特征}$ $i$ 和 $Y-\text{特征}$ $j$ 的概率。假设总体中的不同成员之间是独立的，令

$p_i = P\{X = i\} = \sum_{j=1}^{s} P_{ij}, \quad i = 1, \dots, r$

$q_j = P\{Y = j\} = \sum_{i=1}^{r} P_{ij}, \quad j = 1, \dots, s$

也就是说，$p_i$ 是某个总体成员具有 $X-\text{特征}$ $i$ 的概率，$q_j$ 是其具有 $Y-\text{特征}$ $j$ 的概率。

我们希望检验这样的一个假设：总体成员的 $X-\text{特征}$ 和 $Y-\text{特征}$ 是相互独立的。即，我们希望检验

$$
\begin{align}
H_0: & P_{ij} = p_i q_j, \quad \forall \, i = 1, \dots, r; j = 1, \dots, s \\
\qquad & vs \\ 
H_1: & P_{ij} \neq p_i q_j, \quad \exists i, j \quad i = 1, \dots, r; j = 1, \dots, s
\end{align}
$$

假设我们从总体中抽取了 $n$ 个样本，其中有 $N_{ij}$ 个样本同时具有 $X-\text{特征}$ $i$ 和 $Y-\text{特征}$ $j$，$i = 1, \dots, r; j = 1, \dots, s$。

由于原假设中未指定的 $p_i$ 和 $q_j$，我们必须估计他们，因为 

$N_i = \sum_{j=1}^{s} N_{ij}, \quad i = 1, \dots, r$

表示样本中具有 $X-\text{特征}$ $i$ 的样本数量，$p_i$ 的估计值（事实上是最大似然估计值）为

$\hat{p_i} = \frac{N_i}{n}, \quad i = 1, \dots, r$

同样地，令

$M_j = \sum_{i=1}^{r} N_{ij}, \quad j = 1, \dots, s$

表示样本中具有 $Y-\text{特征}$ $j$ 的样本数量，则 $q_j$ 的估计值为

$\hat{q_j} = \frac{M_j}{n}, \quad j = 1, \dots, s$

乍一看，我们似乎需要使用数据来估计 $r + s$ 个参数。然而，由于 $p_i$ 的和与 $q_j$ 的和都必须为 1，也就是说，$\sum_{i=1}^{r} p_i = \sum_{j=1}^{s} q_j = 1$。所以，我们实际上只需要估计 $r-1$ 个 $p_i$ 和 $s-1$ 个 $q_j$。例如，如果 $r = 2$，因为 $p_2 = 1 - p_1$，所以一旦估计了 $p_1$，就可以自动推导出 $p_2$。因此，我们实际上需要估计 $r - 1 + s - 1 = r + s - 2$ 个参数，由于每个总体成员都有 $k = rs$ 个不同的可能取值，在 $n$ 较大的情况下，检验统计量将近似服从自由度为 $rs - 1 - (r + s - 2) = (r-1)(s-1)$ 的卡方分布。

所以，当 $H_0$ 为真时，

$E[N_{ij}] = nP_{ij} = np_iq_j$

因此，检验统计量 $T$ 的定义为

$T = \sum_{j=1}^{s} \sum_{i=1}^{r} \frac{(N_{ij} - n \hat{p_i} \hat{q_j})^2}{n \hat{p_i} \hat{q_j}} = \sum_{j=1}^{s} \sum_{i=1}^{r} \frac{N_{ij}^2}{n \hat{p_i} \hat{q_j}} - n$

如果检验统计量的值为 $T = t$，则相应的 $p-\text{value}$：

$\begin{align} p-\text{value} &= P_{H_0}(T \geq t) \\ &\approx P\{\chi^2_{(r-1)(s-1)} \gt t\} \\ &= 1 - \text{pchisq}(t, (r-1)(s-1)) \end{align}$

::: {#exr-11_4_a}
我们随机选取了 300 个人作为样本，并对其按照性别和政治派别（民主党人、共和党人、无党派人士）进行分类。如下的列联表展示了所得到的数据。

|$i$/$j$|民主党人|共和党人|无党派人士|总计|
|----|----|----|----|----|
|女性|68|56|32|156|
|男性|52|72|20|144|
|总计|120|128|52|300|

例如，列联表表明，在 300 人的样本中，有 68 名女性是民主党，56 名女性是共和党，32 名女性是无党派人士；即 $N_{11}=68$，$N_{12}=56$，$N_{13}=32$。类似地，$N_{21}=52$，$N_{22}=72$，$N_{23}=20$。

利用这些数据检验随机选取的一个人的性别和政治派别是独立的这一假设。
:::

::: {#sol-11_4_a}
根据上述数据，我们得到 $n\hat{p_i}\hat{q_j}=\frac{N_iM_j}{n}$ 的 6 个值如下：

$\frac{N_{1}M_{1}}{n}=\frac{156\times120}{300}=62.40$
$\frac{N_{1}M_{2}}{n}=\frac{156\times128}{300}=66.56$
$\frac{N_{1}M_{3}}{n}=\frac{156\times52}{300}=27.04$
$\frac{N_{2}M_{1}}{n}=\frac{144\times120}{300}=57.60$
$\frac{N_{2}M_{2}}{n}=\frac{144\times128}{300}=61.44$
$\frac{N_{2}M_{3}}{n}=\frac{144\times52}{300}=24.96$

因此，检验统计量的值为：

$\begin{align} TS&=\frac{(68 - 62.40)^{2}}{62.40}+\frac{(56 - 66.56)^{2}}{66.56}+\frac{(32 - 27.04)^{2}}{27.04}+\frac{(52 - 57.60)^{2}}{57.60} \\ &+\frac{(72 - 61.44)^{2}}{61.44}+\frac{(20 - 24.96)^{2}}{24.96}\\ &=6.433 \end{align}$

$(r - 1)(s - 1)=2$，我们使用 R 来获得 $p-\text{value}$。

```{r}
#| code-fold: false
#| warning: false

p_value <- 1 - pchisq(6.433, 2)
p_value
```

因此，在 5% 的显著性水平下，我们将拒绝性别和政治派别是独立的原假设。

::: {.callout-note}
我们可以直接使用 R 中的卡方检验函数来进行检验。

```{r}
#| code-fold: false
#| warning: false

women <- c(68, 56, 32)
men <- c(52, 72, 20)
data <- matrix(c(women, men), nrow = 2, byrow = TRUE)
colnames(data) <- c("Democrat", "Republican", "Independent")
rownames(data) <- c("Women", "Men")

data

chisq.test(data)
```
:::

$\blacksquare$
:::

::: {#exr-11_4_b}
一家公司每天会安排三个不同的班次工人来操作四台机器。下面的列联表展示了在六个月的时间里的机器故障数据。

|班次\机器|机器 A|机器 B |机器 C|机器 D|总计|
|----|----|----|----|----|----|
|班次 1|10|12 | 6 | 7 | 35|
|班次 2|10|24 | 9 | 10| 53|
|班次 3|13|20 | 7 | 10| 50|
|每台机器总计| 33 | 56 | 22 | 27| 138|

: 机器故障数 {#tbl-11_2}

假设我们希望确定某台机器在特定班次发生故障的概率是否受该班次的影响。换句话说，对于任意一次故障，我们希望检验导致故障的机器和故障发生的班次之间是否独立。
:::

::: {#sol-11_4_b}
根据计算，我们得出检验统计量的值为 1.8148。因此，$p-\text{value}$ 为：

```{r}
#| code-fold: false
#| warning: false

p_value <- 1 - pchisq(1.9148, 6)
p_value
```

因此，我们将接受导致故障的机器和故障发生的班次是独立的假设。$\blacksquare$
:::