## 二项分布的假设检验
二项分布在工程问题中经常遇到。例如，考虑一种产品生产线，该生产线制造的产品可以分为两类——可接受的或有缺陷的。通常会假设生产的每个产品的缺陷概率为 $p$，因此一个具有 $n$ 个产品的样本中的缺陷产品数量将是参数为 $(n, p)$ 的二项分布。现在考虑以下的假设检验：

$H_0 : p \le p_0 \quad vs \quad H_1 : p > p_0$

其中 $p_0$ 是某个指定的值。

如果令 $X$ 表示样本大小为 $n$ 的样本中的缺陷数，那么显然当 $X$ 较大时我们希望拒绝 $H_0$。为了计算在显著性水平 $\alpha$ 下需要多大的 $X$ 才能证明拒绝是合理的，我们关注到：

$P\{X \ge k\} = \sum_{i=k}^{n} P\{X = i\} = \sum_{i=k}^{n} \binom{n}{i} p^i (1 - p)^{n-i}$

现在，很直观（并且可以证明），$P\{X \ge k\}$ 是 $p$ 的递增函数——即，样本中包含至少 $k$ 个缺陷产品的概率随着缺陷概率 $p$ 的增加而增加。使用这一点，我们看到当 $H_0$ 为真时（即 $p \le p_0$），

$P\{X \ge k\} \le \sum_{i=k}^{n} \binom{n}{i} p_0^i (1 - p_0)^{n-i}$

因此，显著性水平 $\alpha$ 下的假设检验

$H_0 : p \le p_0 \quad vs \quad H_1 : p > p_0$ 

是当 $X \ge k^*$ 时拒绝 $H_0$，其中 $k^*$ 是使 $\sum_{i=k}^{n} \binom{n}{i} p_0^i (1 - p_0)^{n-i} \le \alpha$ 成立的最小的 $k$ 值。也就是说，

$k^* = \min \left\{ k : \sum_{i=k}^{n} \binom{n}{i} p_0^i (1 - p_0)^{n-i} \le \alpha \right\}$

可以通过首先确定检验统计量的值——例如 $X = x$，然后再计算给定的 $p$-值 来执行假设检验。

$$
\begin{align}
p-\text{value} &= P\{B(n, p_0) \ge x\} \\
&= \sum_{i=x}^{n}{\left(\begin{array}{cc}  n \\ i  \end{array}\right)p_0^i(1-p_0)^{n-i}}
\end{align}
$$

::: {#exr-8_6_a}
一家电脑芯片制造商声称他们出售的芯片的缺陷率不超过 2%。一家电子公司对这家芯片公司的声明印象深刻，并购买了该芯片公司生产的大量芯片。为了确定芯片制造商的声明的可信性，该电子公司决定测试 300 个芯片样本。如果最终发现这 300 个芯片中有 10 个是有缺陷的，那么是否应该拒绝芯片制造商的声明？
:::

::: {#sol-8_6_a}
让我们在 5% 的显著性水平上检测制造商的声明。为了判断是否需要拒绝制造商 2% 缺陷率的声明，我们需要计算当 $p$ 等于 0.02 时，300 个样本中出现 10 个或更多个缺陷产品的概率。也就是说，我们需要计算 $p-\text{value}$。如果 $p-\text{value}$ 小于或等于 0.05，那么就应该拒绝制造商 2% 缺陷率的声明。

$$
\begin{align}
P_{0.02}\{X \ge 10\} &= 1 - P_{0.02}\{X \le 9\} \\
&= 1 - pbinom(9, 300, 0.02) \\
&= 0.08183807
\end{align}
$$

因此，在显著性水平为 0.05 时，我们不能拒绝芯片制造商的声明。

::: {.callout-note}
当然，在 R 中，我们可以使用 `binom.test()` 来直接根据实验结果计算二项分布的 $p-\text{value}$。

```{r}
binom.test(10, 300, 0.02, "greater")
```
:::

$\blacksquare$
:::

::: {#exr-8_6_b}
为了证明编辑 A 优于编辑 B，给两位编辑提供了一份相同的稿件。如果编辑 A 发现了 28 个错误，而编辑 B 发现了 18 个错误，其中有 10 个错误两人都发现了，我们能否得出编辑 A 更优秀的结论？
:::

::: {#sol-8_6_b}
需要注意的是，A 发现了 B 未发现的 18 个错误，B 发现了 A 未发现的 8 个错误。因此，仅由一人发现的错误总数为 26 个。如果 A 和 B 的能力相当，那么他们单独发现某个错误的概率是相等的，即为 1/2。因此，为了证明 A 是更好的编辑，26 次试验中 18 次成功的结果必须足够强大以拒绝以下假设：

$H_0: p \leq 1/2 \quad vs \quad H_1: p > 1/2$

其中，$p$ 是伯努利试验成功的概率。对于实验数据的 $p-\text{value}$ 为：

$p-\text{value} = P\{B(26, 0.5) \geq 18\} = 0.03776$

因此，在 5% 的显著性水平下，我们将拒绝原假设，所以可以得出结论：在 5% 的显著性水平下，A 是更优秀的编辑。
$\blacksquare$
:::

当样本量 $n$ 较大时，我们可以通过正态分布逼近二项分布来推导显著性水平为 $\alpha$ 的 $H_0: p \leq p_0 \quad vs \quad H_1: p > p_0$ 的近似检验。其原理如下：因为当 $n$ 较大时，随机变量 $X$ 将近似服从均值为

$E[X] = np$

方差为

$\text{Var}(X) = np(1-p)$

的正态分布，因此

$\frac{X - np}{\sqrt{np(1-p)}}$

将近似服从标准正态分布。因此，显著性水平为 $\alpha$ 的近似检验为：

$\text{拒绝} H_0, \quad \text{如果} \frac{X - np_0}{\sqrt{np_0(1-p_0)}} \geq z_\alpha$

同样的，也可以使用正态分布来近似来计算 $p-\text{value}$。

::: {#exm-8_6_c}
在 @exr-8_6_a 中，$np_0 = 300 \times 0.02 = 6$，且 $\sqrt{np_0(1-p_0)} = \sqrt{5.88}$。因此，由数据 $X = 10$ 得出的 $p-\text{value}$ 为

$\begin{align} p-\text{value} &= P_{0.02}\{X \geq 10\} \\ &= P_{0.02}\{X \geq 9.5\} \\ &P_{0.02}\left\{\frac{X - 6}{\sqrt{5.88}} \geq \frac{9.5 - 6}{\sqrt{5.88}}\right\} \\ &\approx P\{Z \geq 1.443\} \\ &= 0.0745 \end{align}$

因此，精确的 $p-\text{value}$ 为 0.0818，正态分布给出的近似 $p-\text{value}$ 为 0.0745。
:::

假设我们现在希望检验 $p$ 等于某个指定值的原假设，即我们希望检验

$H_0: p = p_0 \quad vs \quad H_1: p \neq p_0$

如果一个具有参数 $n$ 和 $p$ 的二项随机变量 $X$ 的观测值等于 $x$，如果 $x$ 的值显著大于或显著小于在 $p = p_0$ 时的预期值，那么显著性水平为 $\alpha$ 的检验将拒绝原假设 $H_0$。更准确地说，当以下任意一项成立时，检验将拒绝 $H_0$：

$P\{B(n, p_0) \geq x\} \leq \alpha/2 \quad \text{或} \quad P\{B(n, p_0) \leq x\} \leq \alpha/2$

换句话说，当 $X = x$ 时的 $p-\text{value}$ 为

$p-\text{value} = 2 \min \left(P\{B(n, p_0) \geq x\}, P\{B(n, p_0) \leq x\}\right)$

::: {#exr-8_6_d}
历史数据显示，某制造商生产的组件中有 4% 是不合格的。该制造商最近刚刚结束了一场特别激烈的劳资纠纷，所以管理层想知道该劳资纠纷是否会导致 不合格率的变化。如果随机抽取的 500 个样品中有 16 个不合格品（占比 3.2%），在显著性水平为 5% 的情况下，是否足以证明不合格率确实发生了变化？
:::

::: {#sol-8_6_d}
需要足够强的数据支撑，以使得我们在检验以下的假设时拒绝原假设，才能够得出不合格率发生了变化的结论：

$H_0: p = 0.04 \quad vs \quad H_1: p \neq 0.04$

其中 $p$ 是单个组件不合格的概率。500 个样品中有 16 个不合格品的数据的 $p-\text{value}$ 为：

$p\text{-value} = 2 \min\{P\{X \leq 16\}, P\{X \geq 16\}\}$

其中 $X$ 是一个二项式随机变量 $\text{binomial}(500, 0.04)$。因为 $500 \times 0.04 = 20$，我们得知：

$p\text{-value} = 2P\{X \leq 16\}$

由于 $X$ 的均值为 20，标准差为 $\sqrt{20 \times 0.96} \approx 4.38$，显然 $X$ 小于等于 16 的概率是比均值小于一个标准差的概率略小的一个值，该值的两倍并非足够小以允许我们拒绝原假设。事实上，可以证明：

$p-\text{value} = 2P\{X \leq 16\} = 0.43161$

因此，没有足够的证据拒绝原假设，即不合格品率仍将保持不变。$\blacksquare$
:::

### 检验两个伯努利总体的参数是否相同 {#sec-8_6_1}
假设某类型的芯片有两种不同的生产方法，并且假设第一种生产方法生产的芯片的缺陷率为 $p_1$，而第二种生产方法生产的芯片的缺陷率为 $p_2$。为了检验假设 $p_1 = p_2$，我们使用第一种方法生产了 $n_1$ 个芯片作为样本 1，使用第二种方法生产了 $n_2$ 个芯片作为样本 2。

令 $X_1$ 表示样本 1 中的缺陷芯片的数量，$X_2$  表示样本 2 中的缺陷芯片的数量。因此，$X_1$ 和 $X_2$ 是相互独立的二项分布随机变量，其参数分别为 $(n_1, p_1)$ 和 $(n_2, p_2)$。假设 $X_1 + X_2 = k$，那么两个样本总共有 $k$ 个缺陷品。

如果 $H_0$（$p_1 = p_2$）成立，那么 $n_1 + n_2$ 个芯片中的每一个都有相同的概率成为缺陷品。因此 $k$ 个缺陷品的分布与从一个包含  $n_1 + n_2$ 个物品（其中 $n_1$ 是白色物品， $n_2$ 是黑色物品）中随机抽取 $k$ 个样本的分布相同。换句话说，给定总共 $k$ 个缺陷品，当 $H_0$ 成立时，使用第一种方法得到的缺陷品数量的条件分布将具有以下的超几何分布：

$$
P_{H_0}\{X_1 = i | X_1 + X_2 = k\} = \frac{\binom{n_1}{i}\binom{n_2}{k-i}}{\binom{n_1+n_2}{k}}, \quad i = 0, 1, \ldots, k
$$ {#eq-8_6_1}

在检验 $H_0: p_1 = p_2 \quad vs \quad H_1: p_1 \neq p_2$ 时，当使用第一种方法生产的缺陷芯片比例与使用第二种方法生产的缺陷芯片比例差异很大时，似乎可以合理地拒绝原假设。因此，如果总共存在 $k$ 个缺陷品，那么当 $H_0$ 成立时，我们预计 $X_1/n_1$（使用第一种方法生产的缺陷芯片比例）将接近于 $(k - X_1)/n_2$ （使用第二种方法生产的缺陷芯片比例）。当 $X_1$ 非常小或非常大时，$X_1/n_1$ 和 $(k - X_1)/n_2$ 之间的差异会比较大，因此，合理的显著性水平 $\alpha$ 的检验如下所示。

当 $X_1 + X_2 = k$ 时，

$$
\begin{align}
\text{拒绝} H_0 &, \quad \text{如果} P\{X \leq x_1\} \leq \alpha/2 \quad \text{ 或 } \quad P\{X \geq x_1\} \leq \alpha/2 \\
\text{接受} H_0 &, \quad 否则
\end{align}
$$

其中 $X$ 是具有以下概率质量函数的超几何随机变量：

$$
P\{X = i\} = \frac{\binom{n_1}{i}\binom{n_2}{k-i}}{\binom{n_1+n_2}{k}}, \quad i = 0, 1, \ldots, k
$$ {#eq-8_6_2}

$$
p-\text{value} = 2 \min(P\{X \leq x_1\}, P\{X \geq x_1\})
$$ {#eq-8_6_3}

换句话说，如果显著性水平至少为 $\alpha$ 大于等于 $p-\text{value}$，我们将拒绝原假设。这种检验也称之为 Fisher-Irwin 检验。

可以通过使用 R 命令 `phyper(x, n, m, k)` 来计算 @eq-8_6_3 的概率，该命令用于计算超几何随机变量的概率，其参数 $n, m, k$ 代表从一个包含 $n$ 个红球和 $m$ 个蓝球的盒子中随机抽取 $k$ 个球时，抽取的红球数量小于或等于 $x$ 的概率。

::: {.callout-note title="fisher.test() 和列联表"}
在 R 中，可以直接使用 `fisher.test()` 来计算 @eq-8_6_3 所示的 $p-\text{value}$。

要使用 R 的 `fisher.test` 来检验两个二项分布的参数 $p$ 是否一致，首先需要将两个二项分布的结果组织成一个 $2 \times 2$ 的列联表。这个列联表表示两个分布的成功和失败次数。然后，使用 `fisher.test` 来检验两个分布是否独立，从而间接检验它们的参数 $p$ 是否一致。

> 列联表（*contingency table*）是按两个或更多属性对数据分类后所列出的对应分类的频数表，是由两个以上的变量进行交叉分类的频数分布表。

1. **准备数据**：假设我们有两个二项分布的结果，分别记录了其成功次数和失败次数。

    - 假设 A 有 8 次成功，2 次失败。
    - B 有 5 次成功，5 次失败。

    将如上分布数据组织成如下的 $2 \times 2$ 列联表：

    ```{.r}
    data <- matrix(c(8, 2, 5, 5), nrow = 2, byrow = TRUE)
    colnames(data) <- c("Success", "Failure")
    rownames(data) <- c("Distribution A", "Distribution B")
    print(data)
    ```

    输出的表格将是：

    ```
                    Success Failure
    Distribution A        8       2
    Distribution B        5       5
    ```

2. **执行 Fisher 精确检验**：

    ```R
    result <- fisher.test(data)
    print(result)
    ```

3. **解释结果**：

    `fisher.test` 的结果将包括 $p-\text{value}$ 以用来判断两个分布的成功率 $p$ 是否显著不同。

    ```
    Fisher's Exact Test for Count Data

    data:  data
    p-value = 0.315
    alternative hypothesis: true odds ratio is not equal to 1
    95 percent confidence interval:
      0.2943 19.3332
    sample estimates:
    odds ratio 
          3.98 
    ```

    - **p-value**: 如果 $p-\text{value}$ 值大于 0.05，则我们不能拒绝原假设，即没有足够证据表明两个分布的成功率（p 值）不一致。
    - **odds ratio**: 估计的优势比，这里为 3.98，表示 A 的成功与 B 的成功的比率。
    - **95 percent confidence interval**: 这是对优势比的 95% 置信区间。


在 R 的 `fisher.test()` 中，列联表的行和列的顺序对计算结果的 `p-value` 和 `odds ratio` 等值均没有影响，即便如此，我们最好还是按照行优先来组织列联表，以保障结果的可解释性。

1. **`p-value` 不受影响**：
   - Fisher 精确检验的核心是计算列联表中不同行和列组合下观察到的频率是否显著偏离了独立性假设。这个计算基于全排列的可能性，所以 `p-value` 不受行列顺序的影响。
   - 换句话说，无论你如何排列列联表的行和列，`p-value` 会保持一致，因为 Fisher 精确检验本质上是一种对称性检验。

2. **`odds ratio` 不受影响**：
   - 具体来说，`odds ratio` 是通过下列公式计算的：$\text{odds ratio} = \frac{(a \times d)}{(b \times c)}$，其中：
     
     - `a` 是第一行第一列的值
     - `b` 是第一行第二列的值
     - `c` 是第二行第一列的值
     - `d` 是第二行第二列的值
   - 根据 `odds ratio` 的计算公式可知，对于列联表而言，无论是行优先、还是列优先的存储方式，都不会影响最终的结果，但是为了保障可解释性，我们最好还是按照行优先来组织列联表，即：
     
     ```
                Success Failure
     Group A        8       2
     Group B        5       5
    ```
:::

::: {#exr-8_6_e}
假设方法 1 生产的 100 个晶体管中有 20 个不合格，而方法 2 生产的 100 个晶体管中有 12 个不合格。我们能否以 10% 的显著性水平得出这两种方法是等效的这样的结论？
:::

::: {#sol-8_6_e}
利用 R，我们得到如下的数据：

$\begin{align} p-\text{value} & = 2 \min(P(X \leq 20), \, P(X \geq 20)) \\ &= 2 \min(P(X \leq 20), \, 1 - P(X \leq 19)) \\ & =2 \times \min(\text{phyper}(20, 100, 100, 32), \, 1 - \text{phyper}(19, 100, 100, 32)) \\ &= 0.1763396 \end{align}$

在上述计算中使用了 R 函数 `min(x, y)`，该函数返回 $x$ 和 $y$ 中的最小值。根据 $p-\text{value}$ 的值，我们无法拒绝这两种方法是等效的假设。

::: {.callout-note}
更简单的，我们可以直接使用 R 中的 `fisher.test()` 来计算 $p-\text{value}$。

```{r}
#| code-fold: false
#| warning: false

data <- matrix(c(20, 80, 12, 88), ncol=2, byrow=TRUE)
rownames(data) <- c("Method 1", "Method 2")
colnames(data) <- c("Unacceptable", "Acceptable")
fisher.test(data)
```
:::
$\blacksquare$
:::

检验两种不同治疗方法效果是否相同的理想方法是将一组人随机分成两组，一组接受第一种治疗方法，另一组接受第二种治疗方法。然而，这种随机分组的方式并非总是万能的。例如，如果我们想研究饮酒是否会增加患前列腺癌的风险，我们不能让随机选择的样本人群去饮酒。**观察性研究**（*observational study*）是研究这种假设的另一种方法，这种方法：

* 首先，随机选择一组饮酒人群和一组不饮酒人群
* 然后，在一段时间内跟踪这些随机选择的人群
* 最后，使用所得到的跟踪数据来检验假设并判断这两组人群患前列腺癌的风险是否相同

接下来的 @exm-8_6_f 展示了实现 **观察性研究** 的另一种方法。

::: {#exm-8_6_f}
1970 年，研究人员 Herbst、Ulfelder 和 Poskanzer (H-U-P) 怀疑年轻女性中一种相当罕见的疾病——阴道癌，可能是由于她们的母亲在怀孕期间服用了己烯雌酚（*Diethylstilbestrol*，通常称为 DES）而引起的。为了研究这种可能性，研究人员可以通过搜索获得一组在其母亲怀孕时服用了 DES 的女性（实验组（*treatment*））和一组在其母亲怀孕时没有服用 DES 的女性（对照组（*control*））来进行 **观察性研究**。然后，研究人员可以在一段时间内去观察这些不同组的人群，并使用所得到的数据进行检验假设——即这两组不同人群的阴道癌发病概率是否相同。然而，对于这两组人群而言，阴道癌都非常罕见，所以这样的研究需要具备较大的群体规模，并且还需要跟踪观察多年才能获得一个显著的结果。因此，H-U-P 决定采用另一种不同的 **观察性研究** 方法。他们发现了年龄在 15 至 22 岁之间的患有阴道癌的 8 名女性。这些女性（称为病例）中的每一名都与 4 名其他女性（称为参照（*referents*）或对照(*controls*)）进行了匹配。每个病例的任何一个参照者都没有患癌症，并且与对应病例出生在相同医院的、相同类型的房间（无论是私人房间还是公共房间），同时其出生日期相差不超过 5 天。研究人员认为，如果 DES 对阴道癌没有影响，那么病例的母亲服用了 DES 的概率 $p_c$ 应该与参照者的母亲服用了 DES 的概率 $p_r$ 相同，所以 H-U-P 决定检验以下假设：

$H_0 : p_c = p_r \quad vs \quad H_1 : p_c \neq p_r$

研究发现，8 个病例中有 7 个病例的母亲在怀孕时服用了 DES，而 32 个参照者中没有一个参照者的母亲服用了该药物。研究人员[^HUP]得出结论：DES 与阴道癌之间存在强关联（这些数据的 $p-\text{value}$ 约等于 0）。

::: {.callout-note}
```{r}
#| code-fold: false
#| warning: false

data <- matrix(c(7, 1, 0, 32), ncol = 2, byrow = TRUE)
rownames(data) <- c("Treatment", "Control")
colnames(data) <- c("C", "NC")
data
fisher.test(data)
```
:::
$\blacksquare$
:::

当样本量 $n1$ 和 $n2$ 比较大时，我们可以通过正态分布逼近二项分布来推导显著性水平为 $\alpha$ 时的原假设 $H_0: p_1 = p_2$ 的近似检验，具体参见：习题 63。

[^HUP]: [Herbst, A., Ulfelder, H., and Poskanzer, D., Adenocarcinoma of the Vagina: Association of Maternal Stilbestrol Therapy with Tumor Appearance in Young Women, New England Journal of Medicine, 284, 878-881, 1971](https://www.nejm.org/doi/full/10.1056/NEJM197104222841604)